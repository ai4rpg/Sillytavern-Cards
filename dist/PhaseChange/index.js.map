{"version":3,"file":"index.js","mappings":"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","sources":["src://tavern_helper_template/src/PhaseChange/index.ts"],"sourcesContent":["$(() => {\n  // ===================================================================\n  // 集中管理所有变量路径，提升代码的可读性、健壮性与可维护性。\n  // ===================================================================\n  const PATHS = {\n    // user\n    CURRENT_PHASE: 'stat_data.user.current_phase[0]',\n    ACTION_POINTS: 'stat_data.user.action_points[0]',\n    EXCITEMENT: 'stat_data.user.sex_statue.body_excitement[0]',\n    DESIRE: 'stat_data.user.sex_statue.spiritual_desire[0]',\n    ABILITIES: 'stat_data.user.special_abilities[0]',\n    BLESSING: 'stat_data.user.profile.bless_old_gods[0]',\n    SOLVED_CASES_COUNT: 'stat_data.user.profile.solved_cases_count[0]',\n    // world\n    CASE_NAME: 'stat_data.world.current_case.case_name[0]',\n    CASE_LOCATION: 'stat_data.world.current_case.case_location[0]',\n    DIFFICULTY_CLASS: 'stat_data.world.current_case.difficulty_class[0]',\n    OUT_OF_CONTROL: 'stat_data.world.current_case.out_of_control[0]',\n    // latent_variables\n    PHASE_CHANGED: 'stat_data.latent_variables.ejs_index.phase_changed[0]',\n    EXPERIENCE: 'stat_data.latent_variables.ejs_index.experience[0]',\n    CANDIDATE_QUALITIES: 'stat_data.latent_variables.ability_update.candidate_ability_qualities[0]',\n    GENERATED_ABILITIES: 'stat_data.latent_variables.ability_update.generated_abilities[0]',\n  } as const;\n\n  // ===================================================================\n  // 核心逻辑函数模块\n  // ===================================================================\n  /**\n   * 初始化候选能力的品质。\n   * @param {any} stats - stat_data 对象。\n   * @param {number} bias - 随机偏移量。\n   */\n  function initializeAbilityQualities(stats: any, bias: number = 0): void {\n    const blessing: string | undefined = _.get(stats, PATHS.BLESSING);\n\n    const DEFAULT_BIAS_MAP: Record<string, number> = { Bast: 0, Hypnos: 0, Nodens: 0 };\n    const BIAS_MAP: Record<string, Record<string, number>> = {\n      猫的庇护: { ...DEFAULT_BIAS_MAP, Bast: 5 },\n      面庞的庇护: { ...DEFAULT_BIAS_MAP, Hypnos: 5 },\n      隐者的庇护: { ...DEFAULT_BIAS_MAP, Nodens: 5 },\n    };\n\n    const BLESSING_BIASES = (blessing && BIAS_MAP[blessing]) || DEFAULT_BIAS_MAP;\n\n    const ABILITY_QUALITIES_WEIGHTED = [\n      ...Array(27).fill('普通'),\n      ...Array(9).fill('稀有'),\n      ...Array(3).fill('史诗'),\n      '传说',\n    ];\n    _.update(stats, PATHS.CANDIDATE_QUALITIES, (candidates: Record<string, [string, string]>) =>\n      _.mapValues(candidates, (value, key) => {\n        const max_bias = ABILITY_QUALITIES_WEIGHTED.length - 1;\n        const final_bias = Math.min(bias + (BLESSING_BIASES[key as string] || 0), max_bias);\n        const quality = ABILITY_QUALITIES_WEIGHTED[_.random(final_bias, max_bias)];\n        return [quality, value[1]];\n      }),\n    );\n    _.set(stats, PATHS.GENERATED_ABILITIES, []);\n    console.log(`已根据经验值和旧神的庇护抽选候选能力品质, 等待AI响应。`);\n  }\n\n  /**\n   * 根据难度等级初始化案件。\n   * @param {any} stats - stat_data 对象。\n   * @param {number} bias - 由经验值计算的难度偏移。\n   */\n  function initializeCase(stats: any, bias: number): void {\n    const difficulty_class = Math.max(1, Math.floor((Math.random() * 5 + bias + 2) / 3));\n    _.set(stats, PATHS.DIFFICULTY_CLASS, difficulty_class);\n    _.set(stats, PATHS.ACTION_POINTS, difficulty_class * 5 + 5);\n    _.set(stats, PATHS.OUT_OF_CONTROL, 50);\n  }\n\n  /** 清理案件相关的核心信息。*/\n  function clearCaseInfoProgress(stats: any, daily_ap: number): void {\n    _.set(stats, PATHS.CASE_NAME, '');\n    _.set(stats, PATHS.CASE_LOCATION, '');\n    _.set(stats, PATHS.DIFFICULTY_CLASS, 0);\n    _.set(stats, PATHS.ACTION_POINTS, daily_ap);\n    _.set(stats, PATHS.OUT_OF_CONTROL, 0);\n  }\n\n  /** 重置所有非被动技能的使用状态。*/\n  function resetActiveSkills(stats: any): void {\n    const abilities: any[] = _.get(stats, PATHS.ABILITIES, []);\n    let resetCount = 0;\n    abilities.forEach(ability => {\n      if (ability && _.get(ability, 'is_passive[0]') === false && _.get(ability, 'is_used[0]') === true) {\n        _.set(ability, 'is_used[0]', false);\n        resetCount++;\n      }\n    });\n    if (resetCount > 0) {\n      console.log(`已成功重置 ${resetCount} 个主动技能的使用状态。`);\n    }\n  }\n\n  /** 重置所有被动技能的使用状态。*/\n  function resetPassiveSkills(stats: any): void {\n    const abilities: any[] = _.get(stats, PATHS.ABILITIES, []);\n    let resetCount = 0;\n    abilities.forEach(ability => {\n      if (ability && _.get(ability, 'is_passive[0]') === true && _.get(ability, 'is_used[0]') === true) {\n        _.set(ability, 'is_used[0]', false);\n        resetCount++;\n      }\n    });\n    if (resetCount > 0) {\n      console.log(`已成功修正 ${resetCount} 个被动技能的使用状态。`);\n    }\n  }\n\n  /** 根据当前阶段决定是否需要计算新的 phase_changed **/\n  function changedIndexUpdate(stats: any): void {\n    const current_phase: string = _.get(stats, PATHS.CURRENT_PHASE);\n    let action_points: number = _.get(stats, PATHS.ACTION_POINTS);\n    const out_of_control: number = _.get(stats, PATHS.OUT_OF_CONTROL);\n    const PHASE_TRANSITION_RULES: Record<string, () => number> = {\n      日常阶段: () => (action_points <= 0 ? 2 : -1),\n      侦破阶段: () => (out_of_control <= 0 ? 3 : action_points <= 0 ? 4 : -1),\n    };\n\n    if (current_phase === '日常阶段') {\n      action_points -= 1;\n    }\n\n    let phase_changed: number = _.get(stats, PATHS.PHASE_CHANGED);\n\n    if (phase_changed === 0) {\n      phase_changed = 1;\n    } else if (phase_changed === -1) {\n      const rule = PHASE_TRANSITION_RULES[current_phase];\n      if (rule) phase_changed = rule();\n    } else if (phase_changed === 1 || phase_changed === 2) {\n      phase_changed = -1;\n    } else if (phase_changed >= 3) {\n      phase_changed = 1;\n    }\n\n    _.set(stats, PATHS.PHASE_CHANGED, phase_changed);\n    _.set(stats, PATHS.ACTION_POINTS, action_points);\n  }\n\n  function statDataUpdate(stats: any, daily_ap: number): void {\n    const difficulty_class: number = _.get(stats, PATHS.DIFFICULTY_CLASS);\n    const experience: number = _.get(stats, PATHS.EXPERIENCE);\n    const LEVEL_RULE = (expr: number): number => {\n      for (let i = 0; i < 5; i++) {\n        expr -= i * 3;\n        if (expr <= 0) return i;\n      }\n      return 5;\n    };\n\n    changedIndexUpdate(stats);\n    const phase_changed: number = _.get(stats, PATHS.PHASE_CHANGED);\n\n    if (phase_changed === 1) {\n      resetActiveSkills(stats);\n      clearCaseInfoProgress(stats, daily_ap);\n      initializeAbilityQualities(stats, experience);\n      _.set(stats, PATHS.CURRENT_PHASE, '日常阶段');\n    } else if (phase_changed === 2) {\n      _.set(stats, PATHS.CURRENT_PHASE, '侦破阶段');\n      const level = LEVEL_RULE(experience);\n      initializeCase(stats, level);\n    } else if (phase_changed >= 3) {\n      _.update(stats, PATHS.EXPERIENCE, (expr: number) => expr + difficulty_class * 3);\n      _.update(stats, PATHS.SOLVED_CASES_COUNT, (count: number) => count + 4 - phase_changed);\n      _.update(stats, PATHS.EXPERIENCE, (expr: number) => expr + difficulty_class * (9 - phase_changed * 2));\n      _.set(stats, PATHS.CURRENT_PHASE, '后日谈阶段');\n      _.set(stats, PATHS.ACTION_POINTS, 1);\n    }\n  }\n\n  function nonNegative(value: number): number {\n    return value >= 0 ? value : 0;\n  }\n\n  function valuesCorrection(stats: any): void {\n    _.update(stats, PATHS.ACTION_POINTS, nonNegative);\n    _.update(stats, PATHS.EXCITEMENT, nonNegative);\n    _.update(stats, PATHS.DESIRE, nonNegative);\n    _.update(stats, PATHS.OUT_OF_CONTROL, nonNegative);\n    resetPassiveSkills(stats);\n  }\n\n  // ===================================================================\n  // 主事件监听器\n  // ===================================================================\n  eventOn('mag_variable_update_ended', async (variables: any) => {\n    try {\n      const last_message_id = getLastMessageId();\n      const messages = getChatMessages(last_message_id);\n      if (!messages || messages.length === 0) {\n        console.error('无法加载最新楼层消息。');\n        return;\n      }\n      const role = messages[0].role;\n      if (role === 'user') {\n        const daily_ap = last_message_id <= 1 ? 3 : 5;\n        statDataUpdate(variables, daily_ap);\n        console.log('后台状态更新已成功应用。');\n      }\n      valuesCorrection(variables);\n    } catch (e) {\n      console.error('脚本错误:', e);\n    }\n  });\n  console.log(\"世界状态后台自动化脚本已加载并监听 'mag_variable_update_ended' 事件。\");\n});\n"],"names":["$","PATHS","statDataUpdate","stats","daily_ap","difficulty_class","_","get","experience","current_phase","action_points","out_of_control","PHASE_TRANSITION_RULES","phase_changed","rule","set","changedIndexUpdate","abilities","resetCount","forEach","ability","console","log","resetActiveSkills","clearCaseInfoProgress","bias","blessing","DEFAULT_BIAS_MAP","Bast","Hypnos","Nodens","BIAS_MAP","BLESSING_BIASES","ABILITY_QUALITIES_WEIGHTED","Array","fill","update","candidates","mapValues","value","key","max_bias","length","final_bias","Math","min","random","initializeAbilityQualities","max","floor","initializeCase","expr","i","LEVEL_RULE","count","nonNegative","valuesCorrection","resetPassiveSkills","eventOn","async","variables","last_message_id","getLastMessageId","messages","getChatMessages","error","role","e"],"sourceRoot":""}